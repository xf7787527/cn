# 在线迁移教程

在线迁移流程如下图所示，本文将详细介绍各环节的操作步骤。
![](https://img1.jcloudcs.com/cn/image/vm/migration-operation-overview.png)

## 迁移前准备
### 1、迁移条件确认
#### 1.1、运行环境确认<br>

**仅支持与以下京东云官方镜像操作系统一致的KVM虚拟化运行环境迁移，且须保证系统类型、版本、内核、位数完全一致**。同时，为确保迁移后可在京东云环境下正常运行并支持平台提供的生命周期管理能力，请参照 [导入镜像](https://docs.jdcloud.com/cn/virtual-machines/import-private-image) 的要求尽量保持系统关键配置一致。
* CentOS（64位）：8.2/7.6/7.3/7.2/6.9
* Ubuntu（64位）：18.04/16.04/14.04

#### 1.2、 网络联通确认<br>
由于源节点、目标节点、控制节点须保证两两网络可达，因此通常情况下，意味着三个节点均需要具有公网访问的能力，请提前规划好网络联通方式。同时，各节点需要开放下述端口，请提前确认与当前业务在用端口是否有冲突。

| 节点类型                | 端口协议                | 端口          |
| :------------------- | :------------------- |:---------------|
| 源节点  | TCP | 26821 |
| 目标节点   | TCP   | 26821/26831/26832/26833          |
| 控制节点   | TCP   | 26803/58080/58086   |


### 2、创建目标节点
根据待迁移节点的操作系统版本，在京东云环境下预先创建出与其匹配的目标节点主机，如涉及多个节点迁移，请尽量在云主机名称上有所区分和匹配，便于后续配置迁移任务。关于云主机创建详见 [创建云主机](https://docs.jdcloud.com/virtual-machines/create-instance)。

### 3、购买迁移许可
在线迁移服务为付费服务，可前往 [京东云云市场](https://market.jdcloud.com/service/details/585155) 购买。建议您提前与京东云客服联系，获得在线迁移可执行情况的评估协助，再行购买合适数量的迁移许可。

## 迁移节点配置
### 1、安装迁移服务
请根据迁移节点的操作系统及版本，下载对应的代理程序安装包，源节点和目标节点均需要安装且安装步骤相同。

#### 1.1、下载迁移代理程序安装包
| 操作系统及版本          | 迁移代理程序安装包（以华北为例）                | 
| :------------------- | :-------------------|
| CentOS 8.x  |   https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-el8.x86_64.rpm| 
| CentOS 7.x  | https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-el7.x86_64.rpm |
| CentOS 6.x  | https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-el6.x86_64.rpm  | 
| Ubuntu 18.04  | https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-ubuntu.18.04.5.x86_64.deb   |
| Ubuntu 16.04  | https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-ubuntu.16.04.2.x86_64.deb   | 
| Ubuntu 14.04  | https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-i2node-7.1.72.22012416-ubuntu.14.04.x86_64.deb   | 

```
wget https://bj-vm-migration.s3.cn-north-1.jdcloud-oss.com/info2soft-<i2-version>.<os-version>.rpm
```

内网环境下载时，请将链接中的bucket地址 "bj" 和地域参数 "cn-north-1" 分别替换成主机所在地域的代码，并将域名中的 "s3" 改为 "s3-internal" ，将会使用免费内网流量下载：
* 华北-北京："bj","cn-north-1"
* 华南-广州："gz","cn-south-1"
* 华东-宿迁："sq","cn-east-1"
* 华东-上海："sh","cn-east-2"

#### 1.2、安装代理程序
1.2.1、CentOS系统安装代理程序

执行rpm包安装。
```
rpm -ivh info2soft-i2node-<i2-version>.<os-version>.rpm
```

如果系统是最小安装的，将会提示缺少zip, unzip, psmisc等3个软件包，可直接使用yum安装。

```
yum install -y zip unzip psmisc
```

在安装模式处，选择“1”；加载块复制驱动处，选择“n”；修改监听端口提示处，选择“n”。随后按回车键完成安装。
确认以下进程是否开启，以确保服务成功安装。

```
service i2node status
```

1.2.2、Ubuntu系统安装代理程序

执行deb包安装。

```
sudo dpkg -i info2soft-i2node-<i2-version>.<os-version>.rpm
```

如果系统是最小安装的，将会提示缺少 unzip 包，可直接使用 apt-get 安装。

```
sudo apt-get install -y unzip
```

在安装模式处，选择“1”；加载块复制驱动处，选择“n”；修改监听端口提示处，选择“n”。随后按回车键完成安装。
![](https://img1.jcloudcs.com/cn/image/vm/migration-operation-inode1.png)

确认以下进程是否开启，以确保服务成功安装。
```
service i2node status
```
### 2、开放服务端口
请确保源节点/目标节点已开放对应服务端口，京东云云主机实例端口可通过安全组配置，详见 [配置安全组入站规则](https://docs.jdcloud.com/cn/virtual-machines/configurate-inbound-rules)。
* 源节点：TCP-26821
* 目标节点：TCP-26821/26831/26832/26833

## 控制节点配置
京东云提供了预装迁移服务平台的镜像，您只需使用该镜像创建一台云主机（推荐配置4C8G）并绑定一个弹性公网IP，即可通过IP地址+端口的形式快速访问迁移平台，配置迁移任务。

### 1、创建控制节点
登录京东云控制台，进入 [云主机创建页](https://cns-console.jdcloud.com/compute/vm/create?regionId=cn-north-1)：
* 如迁移控制节点后续不打算另作他用可选择“按配置计费”模式，完全迁移后释放云主机，也可直接选择“包年包月”计费模式，迁移完成后通过重置系统功能更换镜像。
* 在镜像配置中，选择 “镜像市场”-“云主机迁移管理平台” 
* 规格建议选择2C4G及以上的规格
* 安全组可先选择“Linux安全组开放22端口”，之后再添加规则
* 弹性公网IP带宽会影响数据迁移时间，可根据迁移节点数据量选择，也可在带宽影响迁移速度时再行调整

其他配置请按需自行选择。

### 2、开放服务端口
请确保控制节点已开放对应服务端口，京东云云主机实例端口可通过安全组配置，详见 [配置安全组入站规则](https://docs.jdcloud.com/cn/virtual-machines/configurate-inbound-rules)。
* 控制节点：TCP-26803/58080/58086

### 3、登录迁移平台
3.1、访问迁移服务平台

打开浏览器，在地址栏输入迁移管理平台的IP地址和端口，格式为：`https://<控制机IP地址>:58086`，首次登录浏览器会遇到阻拦信息，这是因为SSL证书不在浏览器的可信范围内，对于安全没有影响，单击继续浏览即可。

3.2、登录迁移平台

首次登录请统一以账号管理员的身份，用 “sysadmin”/“Jdcloud123！” 的账号和密码登录，登录后会提示修改sysadmin密码，此时请按输入要求重新定义密码。<br>

随后进入“系统管理”-“用户管理”，点击 “admin” 账号右侧的“修改”按钮，将用户状态置为“正常”，并设置密码启用admin账号。<br>

完成上述配置后，可退出sysadmin账号并以admin账号重新登录平台，再次登录后会正式进入迁移控制平台，在默认弹出的“全局配置”弹窗中，选择控制节点当前的内网IP地址为控制台地址；信息采集间隔建议选择“10s”；其他配置可按需自行配置或保持默认。<br>

修改确认后会再次进入密码修改界面，请以admin用户身份再次修改密码，完成设置后即可操作迁移平台。

### 4、添加迁移节点
在迁移服务平台上，点击 “资源管理”-“容灾节点”-“节点管理” 页面中的 “新建” 按钮配置节点信息。源节点和目标节点均需要在添加至服务器平台中。

计划迁移多个节点时，建议名称添加序号并包含应用名称、目标迁移节点地址等信息，以便后续创建迁移任务时能一一对应。管理地址和数据地址均填写源节点的公网IP地址；管理端口保持默认；控制台地址选择控制节点内网IP即可。随后需要输入源节点的root用户名/密码，并点击右侧的 “认证” ，系统会自动访问源节点并进行环境识别，将重要配置信息自动填充到下方的配置项中；软件许可暂时缺省，之后统一配置。
<div align="center"><img src="https://img1.jcloudcs.com/cn/image/vm/migration-operation-console1.png" width="600"></div>

## 迁移许可配置
### 1、导入迁移许可
前往 [云市场](https://market.jdcloud.com/service/details/585155) 按源节点数量购买迁移许可，同一个源节点迁移至多个目标节点，仅消耗一个License。购买完成并通过京东云客服获得迁移许可后，点击 “系统管理”-“许可管理”页面中的 “添加” 将软件注册码填写在页面内，点击 “确定” 后即可在许可管理页面看到迁移授权的相关信息。
![](https://img1.jcloudcs.com/cn/image/vm/migration-operation-license1.png)

### 2、授权迁移节点
迁移许可需要与源节点一一授权绑定，此环节需要京东云配合您完成，源节点授权绑定后将无法更改，请谨慎操作。

点击 “系统设置”-“许可管理” 页面中的 “节点识别码” ，选择需要绑定的源节点，点击页面右下角的 “下载” 按钮，将节点UUID下载至本地。

点击许可列表中，已导入许可右侧操作中的 “更新”，将“SN-序列号”、“密钥”及刚刚下载的UUID 发给京东云客服，稍后我们会返回一组新的注册码，您需要将其复制到 “更新” 窗口中的 “软件注册码”，确定后即完成绑定。返回列表，可以看到许可已使用量进行了更新。随后点击许可右侧的 “查看”，在弹出的对话框中，勾选您需要绑定的源节点和目标节点，单击 “更新绑定” 即可完成对节点的迁移许可授权。
![](https://img1.jcloudcs.com/cn/image/vm/migration-operation-license2.png)

## 迁移任务配置
### 1、创建迁移任务
点击 “业务迁移”-“整机迁移” 页面中的 “新建”。
* 基本设置中，自定义任务名称，“工作机” 选择源节点，“保障机” 选择目标节点。“同步项” 中显示了计划迁移的目录，默认为当前源节点的全部目录，目标机迁移过程中会在目标节点新建路径存放源节点文件，迁移完成后在迁移平台重启目标节点，该路径下的文件会自动覆盖对应原始路径下的文件，完成迁移。如有个别路径不需要迁移，可自行调整。
* 镜像设置中，如源节点主要为非结构化数据或者公网带宽较小，同步数据量较大，可选择时间相对较短的“时间校验”，否则建议选择“严格校验”；错误处理方式建议选择“遇到错误，写入日志并继续同步”；文件打开方式建议选择“普通文件”。
* 网络配置中，请选择第二项 “保留保障机网络设置... ...”。
* 迁移设置中，请选择第一项 “完成系统和数据同步之后，... ...手工切换” 。此选项下，程序将持续监控“基本设置”配置的“同步项”所选择的目录和文件，将新的任何增量数据和文件变化持续复制到目标端，直到您在迁移的界面上单击“迁移”。
* 压缩加密和带宽控制可保持，默认不做修改。
完成以上配置后，点击“确定”。
<div align="center"><img src="https://img1.jcloudcs.com/cn/image/vm/migration-operation-task1.png" width="500"></div>

### 2、启动迁移任务
完成上一步操作后，系统会自动应用迁移规则，并将源节点的存量数据同步至目标节点。迁移任务状态显示“就绪”时，意味着存量数据已同步完成，点击 “迁移” 即可开始增量数据同步。迁移过程中，如果之前配置的迁移规则有调整，可以点击“停止”暂定迁移，修改规则后重新“启动”。
![](https://img1.jcloudcs.com/cn/image/vm/migration-operation-move1.png)

迁移完成后，任务状态变更为“重启就绪”，此时点击“重启”系统会自动完成目录和文件的合并和替换，并删除迁移过程中的临时中间数据。至此，迁移完成，可登陆目标节点进一步确认数据完整性和服务运行情况，也可点击迁移任务右侧的“查看日志”和“查看数据流量”了解迁移过程中的操作步骤和迁移速度等信息。

迁移完成后，如果需要重新迁移，或者同一个源节点需要往其他目标节点迁移，均需要重新新建任务。

确认迁移已完成后，可将源节点和目标节点中的迁移代理服务卸载，并清除元数据目录.

CentOS系统：
```
rpm -e info2soft-i2node
rm -rf /etc/sdata
rm -rf /var/i2data
```

Ubuntu系统：
```
sudo dpkg -e info2soft-i2node-<i2-version>.<os-version>.deb
rm -rf /etc/sdata
rm -rf /var/i2data
```

